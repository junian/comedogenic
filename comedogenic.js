var dataAcneOrg = [["Acetylated lanolin ", "4", "0"], ["Acetylated lanolin acohol ", "4", "2"], ["Anhydrous lanolin ", "0-1", "?"], ["Lanolin alchol ", "0-2", "2"], ["PEG 16 lanolin (Solulan 16) ", "4", "3"], ["PEG 75 lanolin ", "0", "0"], ["Laurie acid ", "4", "1"], ["Lauric acid ", "4", "?"], ["Myristic acid ", "3", "0"], ["Dioctyl succinate ", "3", "2"], ["Syearyl Heptanoate ", "4", "0"], ["Palmitic acid ", "2", "0"], ["Stearic acid ", "2", "0"], ["Behenic acid ", "0", "0"], ["Ascorbytl palmitate ", "2", "0"], ["Butyl stearate ", "3", "0"], ["Decyl oleate ", "3", "0"], ["Dilsopropyl adipate ", "0", "0"], ["Isopropyl isosterate ", "5", "0"], ["Isopropyl myristate ", "5", "3"], ["Isopropyl palmitate ", "4", "1"], ["Isopropyl linolate ", "5", "?"], ["Isostearyl neopentanoate ", "3", "3"], ["Isostearyl isostearate ", "4", "1"], ["Myristyl lactate ", "4", "2"], ["Octydodecyl stearate ", "0", "0"], ["Stearyl heptanoate ", "4", "0"], ["Tridectyl neopentanoate ", "0", "3"], ["PPG 2 Myristyl Propionate ", "3", "2"], ["Ethylhexyl palmitate ", "4", "?"], ["Isodecyl oleate ", "4", "?"], ["PPG 30 ", "0", "0"], ["SD Alcohol 40 ", "0", "0"], ["Isopropyl alcohol ", "0", "0"], ["Cetyl alcohol ", "2", "2"], ["Cetearyl alcohol ", "2", "1"], ["Stearyl alcohol ", "2", "2"], ["Ceteareth 20 ", "4", "1"], ["Propylene glycol ", "0", "0"], ["PG dicaprylate/caprate ", "1", "0"], ["PG dipelargonate ", "2", "2"], ["Sorbitol ", "0", "0"], ["Sorbitan laurate ", "1", "1"], ["Sorbitan sesquinoleate ", "0", "0"], ["Sorbitan stearate ", "0", "1"], ["Polysorbate 20 ", "0", "0"], ["Polysorbate 80 ", "0", "0"], ["Glycerin ", "0", "0"], ["Glyceryl stearate NSE ", "1", "0"], ["Glyceryl stearate SE ", "3", "2"], ["Pentaerythrital tetra caprai caprylate ", "0", "0"], ["Wheat germ glyceride ", "3", "2"], ["Polyethylene glycol ", "1", "0"], ["PEG 20 stearate ", "1", "0"], ["Laureth-4 ", "5", "4"], ["Laureth-23 ", "3", "0"], ["Oleth-3 ", "5", "2"], ["Oleth-10 ", "2", "1"], ["PPG 30 cetyl ester ", "0", "0"], ["PEG 40 castor oil ", "0", "0"], ["Steareth-2 ", "2", "2"], ["Steareth-10 ", "4", "3"], ["Steareth-20 ", "2", "1"], ["Steareth-100 ", "0", "0"], ["PG Monostearate / Propylene glycol monostearate ", "3", "0"], ["PEG 8 stearate ", "3", "1"], ["Disodium monooleamido PEG 2 Sulfosuccinate ", "4", "?"], ["Glyceryl-3-Diisostearate ", "4", "?"], ["Polyglyceryl-3-diisostearate ", "4", "?"], ["Oleyl alcohol ", "4", "?"], ["Isocetyl alcohol ", "4", "0"], ["Isocetyl stearate ", "5", "?"], ["PEG 200 Dilaurate ", "3", "?"], ["PEG 100 Distearate ", "2", "0"], ["Hexadecyl alcohol ", "5", "?"], ["Octyl stearate ", "5", "?"], ["Myreth 3 Myrisrate ", "4", "?"], ["Candelilla wax ", "1", "0"], ["Camuba wax ", "1", "0"], ["Ceresin wax ", "0", "?"], ["Beeswax ", "0-2", "0"], ["Lanolin wax ", "1", "0"], ["Jojoba oil ", "0-2", "0"], ["Sulfated jojoba oil ", "3", "0"], ["Emulsifying wax NF ", "0-2", "0-2"], ["Carboxymethylcellulose ", "0", "0"], ["Hydroxypropylcellulose ", "1", "0"], ["Magnesium aluminum silicate ", "0", "0"], ["Carbomer 940 ", "1", "0"], ["Bentonite ", "0", "0"], ["Kaolin ", "0", "0"], ["Talc ", "1", "0"], ["Sorbitan oleate ", "3", "0"], ["Olive oil ", "2-4", "?"], ["Cocoa butter ", "4", "0"], ["Coconut butter ", "4", "0"], ["Cocos Nucifera / Coconut oil ", "4", "?"], ["Grape seed oil ", "4", "?"], ["Crisco ", "3", "?"], ["Hydrogenated vegetable oil ", "3", "?"], ["Peach kernel oil ", "4", "?"], ["Linum usitatissiumum seed oil / Linseed oil ", "4", "?"], ["Sesame oil ", "2", "0"], ["Corn oil ", "2-3", "0"], ["Avocado oil ", "2", "0"], ["Almond oil ", "2", "?"], ["Emu oil ", "1", "0"], ["Camphor oil ", "2", "2"], ["Hazelnut oil ", "2", "0"], ["Hemp seed oil ", "0", "?"], ["Evening primrose oil ", "2", "2"], ["Peanut oil ", "2", "1"], ["Pomegranate oil ", "1", "0"], ["Rosehip oil ", "1", "1"], ["Tamanu oil ", "2", "0"], ["Shea butter ", "0", "0"], ["Argan oil ", "0", "0"], ["Mink oil ", "3", "1"], ["Glycine soja oil / Soybean oil ", "3", "0"], ["Shark liver oil ", "3", "2"], ["Triticum Vulgare / Wheat germ oil ", "5", "2"], ["Cotton seed oil ", "3", "?"], ["Cotton awws ", "3", "?"], ["Apricot kernel oil ", "2", "0"], ["Camphor ", "2", "?"], ["Castor oil ", "1", "0"], ["Hydrogenated castor oil ", "1", "0"], ["Sulfated castor oil ", "3", "?"], ["Sandalwood Seed Oil ", "2", "0"], ["Squalane ", "1", "0"], ["Squalene ", "3", "?"], ["Safflower oil (cold pressed only, high lineolic content) ", "0", "0"], ["Safflower oil (cooking variety, high oleic content) ", "4", "?"], ["Mineral oil ", "0", "0"], ["Petrolatum ", "0", "?"], ["Sesame oil ", "2", "?"], ["Sunflower oil ", "0-2", "?"], ["D&C red #6 ", "1", "0"], ["D&C red #9 ", "1", "0"], ["D&C red #19 ", "2", "0"], ["D&C red #27 ", "2", "0"], ["D&C red #30 ", "3", "0"], ["D&C red #36 ", "3", "0"], ["D&C red 40 ", "2", "2"], ["Ultramarine violet ", "0", "0"], ["Iron oxides ", "0", "0"], ["Cafmine ", "0", "0"], ["Titanium dioxide ", "0", "0"], ["Sirnethicone ", "1", "0"], ["Dimethicone ", "1", "0"], ["Cyclomethicone ", "0", "0"], ["Cholesterol ", "0", "0"], ["Soya sterol ", "0", "0"], ["Peg 5 soya sterol ", "0", "0"], ["Peg 10 soya sterol ", "0", "1"], ["Choleth 24 ", "0", "0"], ["Sterol esters ", "0", "0"], ["Algae extract ", "5", "4"], ["Red Algae ", "5", "2"], ["Tocopherol (vitamin E) ", "2", "2"], ["Tocopheryl acetate ", "0", "0"], ["Black walnut extract ", "0", "0"], ["Chammomile extract ", "0", "0"], ["Vitamin Apalmitate ", "2", "2"], ["Panthenol ", "0", "0"], ["Calendula ", "1", "?"], ["Cold Pressed Aloe ", "0", "?"], ["Carrageenans ", "5", "?"], ["Sodium chloride (salt) ", "5", "0-3"], ["Colloidal sulfur ", "3", "?"], ["Flowers of sulfur ", "0", "?"], ["Beta Carotene ", "1", "?"], ["BHA ", "2", "?"], ["Algin ", "4", "?"], ["Potassium Chloride ", "5", "?"], ["Methyl paraben ", "0", "0"], ["Propyl paraben ", "0", "0"], ["Allantoin ", "0", "0"], ["Hydantoin ", "0", "0"], ["Sodium hyaluronate ", "0", "0"], ["Sodium Laureth Sulfate ", "3", "2"], ["Sodium Lauryl Sulfate ", "5", "2"], ["Sodium Myreth Sulfate ", "3", "?"], ["Carbomer 940 ", "1", "?"], ["Hydroxypropyl cellulose ", "1", "?"], ["Kaolin ", "0", "?"], ["Octyl drinethyl PABA ", "0", "0"], ["Oxybenzone ", "0", "0"], ["Octyl methoxycinnamate ", "0", "9"], ["Octyl salicylate ", "0", "0"], ["Lithium stearate ", "1", "0"], ["Magnesium stearate ", "1", "0"], ["Zinc oxide ", "1", "0"], ["Zinc stearate ", "0", "0"], ["Triethanolamine ", "2", "0"], ["Stearic acid TEA ", "3", "2"], ["Sodium PCA ", "0", "0"], ["Hydryolyzed animal protein ", "0", "0"], ["Adamosis stearate ", "2", "2"], ["Xylene ", "4", "3"], ["Zea Mays (Corn Starch) ", "2-4", "2-5"], ["Octyl palmitate ", "4", "1"]]; 
var dataBotanic = [["Almond Oil ","2"], ["Apricot Kernel Oil ","2"], ["Argan Oil ","0"], ["Avocado Oil ","2"], ["Baobab Oil ","2"], ["Borage Oil ","2"], ["Calendula Oil ","1"], ["Camphor ","2"], ["Castor Oil ","1"], ["Cocoa Butter ","4"], ["Coconut Butter ","4"], ["Coconut Oil (from the meat or kernel) ","4"], ["Coconut Oil (from the drupe) ","0"], ["Corn Oil ","3"], ["Cotton Seed Oil ","3"], ["Emu Oil ","1"], ["Evening Primrose Oil ","2"], ["Flax Seed Oil ","4"], ["Grape Seed Oil ","2"], ["Hazelnut Oil ","2"], ["Hemp Seed Oil ","0"], ["Jojoba Oil ","2"], ["Jojoba Oil Sulfated  ","3"], ["Linseed Oil ","4"], ["Mango Butter ","0"], ["Mineral Oil ","0"], ["Mink Oil ","3"], ["Neem Oil ","1"], ["Olive Oil ","2"], ["Palm Oil ","4"], ["Peach Kernel Oil ","2"], ["Peanut Oil ","2"], ["Petrolatum ","0"], ["Pomegranate Oil ","1"], ["Pumpkin Seed Oil ","2"], ["Rosehip Oil ","1"], ["the cooking oil) ","0"], ["Sandalwood Seed Oil ","2"], ["Sea Buckthorn Oil ","1"], ["Sesame Oil ","2"], ["Shea Butter ","0"], ["Soybean Oil ","3"], ["Sunflower Oil ","2"], ["Tamanu Oil ","2"], ["Wheat Germ Oil ","5"], ["Shark Liver Oil ","3"], ["Beeswax ","2"], ["Candelilla Wax ","1"], ["Carnuba Wax ","1"], ["Ceresin Wax ","0"], ["Emulsifying Wax NF ","2"], ["Lanolin Wax ","1"], ["Algae Extract ","5"], ["Aloe Vera Gel ","0"], ["Calendula ","1"], ["Carrageenans ","5"], ["Chamomile ","2"], ["Chamomile Extract ","0"], ["Cold Pressed Aloe ","0"], ["Red Algae ","5"], ["Ascorbic Acid ","0"], ["Black Walnut Extract ","0"], ["Tocopherol (Vitamin E) ","2"], ["Vitamin A Palmitate ","2"], ["Panthenol ","0"], ["Beta Carotene ","1"], ["BHA ","2"], ["Algin ","4"], ["Colloidal Sulfur ","3"], ["Flowers of Sulfur ","0"], ["Potassium Chloride ","5"], ["Precipitated Sulfur ","0"], ["Sodium Chloride (Salt) ","5"], ["Talc ","1"], ["Zinc Stearate ","0"], ["Carbomer 940 ","1"], ["Hydroxypropyl Cellulose ","1"], ["Kaolin ","0"], ["Magnesium Aluminum Silicate ","0"], ["Sodium Laureth Sulfate ","3"], ["Sodium Lauryl Sulfate ","5"], ["Sorbitan Oleate ","3"], ["Polysorbate 20 ","0"], ["Polysorbate 80 ","0"], ["Sterol Esters ","0"], ["Behenyl Triglyceride ","0"], ["Butylene Glycol ","1"], ["Cetearyl Alcohol ","2"], ["Diethylene Glycol Monomethyl Ether","0"], ["Glycerin ","0"], ["Glyceryl Stearate NSE ","1"], ["Glyceryl Stearate SE ","3"], ["Glyceryl Tricapylo/Caprate ","1"], ["Glyceryl-3-Diisostearate ","4"], ["Hexadecyl Alcohol ","5"], ["Isocetyl Stearate ","5"], ["Isopropyl Alcohol ","0"], ["Laureth 23 ","3"], ["Laureth 4 ","5"], ["Octyl Stearate ","5"], ["Oleth-10 ","2"], ["Oleth-3 ","5"], ["Oleyl Alcohol ","4"], ["Polyethylene Glycol (PEG 400) ","1"], ["Polyethylene Glycol 300 ","1"], ["Polyglyceryl-3-Diisostearate ","4"], ["Propylene Glycol ","0"], ["Propylene Glycol Monostearate ","4"], ["SD Alcohol 40 ","0"], ["Sorbitan Laurate ","1"], ["Sorbitol ","0"], ["Steareth 10 ","4"], ["Steareth 100 ","0"], ["Steareth 2 ","2"], ["Steareth 20 ","2"], ["Wheat Germ Glyceride ","3"]]; 
var dataHautschutzengel = [ ["Acetylated Lanolin / Acetyliertes Wollwachs", "4"] ,  ["Acetylated Lanolin Alcohol / Acetyliertes Wollwachsalkohol", "4"] ,  ["Algae Extrakt / Algen Extrakt", "5"] ,  ["Algin / Alginsäure", "4"] ,  ["Algin Acid / Alginsäure", "4"] ,  ["Alkyl Alcohol / Alkylalkohol", "3"] ,  ["Arachis Hypogaea / Erdnußöl", "2"] ,  ["Butyl Stearate / Lipid", "4"] ,  ["Capryl Glycol / Octandiol", "?"] ,  ["Carrageenan / Irish Moos / Rotalge", "5"] ,  ["Carthamus Tinctorius / Distelöl", "3 "] ,  ["Cera microcrystallina / Erdöl", "5 "] ,  ["Ceresin / Erdöl", "5 "] ,  ["Cetearyl Alcohol / Fettalkohol", "2"] ,  ["Cetearyl Alcohol + Ceteareth 20 / PEG", "5"] ,  ["Cetyl Alcohol / Fettalkohol", "2"] ,  ["Cetyl Acetate / Wachs", "4"] ,  ["Cocoa Butter / Kakaobutter", "4"] ,  ["Coconut Butter / Kokosbutter", "4 "] ,  ["Coconut Oil / Kokosöl", "3"] ,  ["Cocos Nucifera / Kokosfett", "4 "] ,  ["Corn Oil / Maisöl", "3"] ,  ["Colloidal Sulfur / Schwefel", "3 "] ,  ["Cotton Seed Oil / Baumwollsamenöl", "3 "] ,  ["Cyclomethicone / Silikon", "5"] ,  ["Decyl Oleate / Pflanzliches Öl", "3 "] ,  ["Dimethicone / Silikon", "5"] ,  ["Dioctyl Succinate / Tensid", "3 "] ,  ["Disodium Oleamido PEG-2 Sulfosuccinate / Tensid", "4 "] ,  ["Ethoxylated Lanolin / Wollfett", "3 "] ,  ["Ethylhexyl Palmitate / Bürzeldrüsenölersatz aus Plamfett", "4 "] ,  ["Ethylhexyl Stearate / Lipid", "5"] ,  ["Flaxseed Oil / Leinsamenöl", "5"] ,  ["Glyceryl Stearate / Emulgator aus Glycerin und Stearinsäure", "3"] ,  ["Glycine Soja / Sojaöl", "3"] ,  ["Polyglyceryl-3-Diisostearate / Emulgator", "4"] ,  ["Heavy Mineral Oil / Steinkohleteer", "5 "] ,  ["Hexadecyl Alcohol / Cetyl Alcohol / Fettalkohol", "5 "] ,  ["Hexylene Glykol / Lösungsmittel", "3"] ,  ["Hydrogenated Vegetable Oil / Pflanzliches Öl", "3 "] ,  ["Isocetyl Alcohol / Fettalkohol", "4"] ,  ["Isocetyl Stearate / Ester der Stearisäure mit Isocetylalkohol", "5 "] ,  ["Isodecyl Oleate / Lipid", "4 "] ,  ["Isopropyl Isostearate / Lipid", "5 "] ,  ["Isopropyl Lanolate / Lipid", "5"] ,  ["Isopropyl Linolate / Lipid", "5"] ,  ["Isopropyl Myristate / Myristinsäureisopropylester", "5 "] ,  ["Isopropyl Palmitate / Ester der Palmitinsäure mit Isopropylalkohol", "4 "] ,  ["Isostearyl Isostearate / Lipid", "4 "] ,  ["Isostearyl Neopentanoate / Ester der Neopentanoic Säure mit Isostearylalkohol", "3 "] ,  ["Isostearic acid / Isooctadecansäure", "5"] ,  ["Lanolin / Wollwachs aus der Talgdrüse vom Schaf", "4 "] ,  ["Lanolin Cera / Wollwachs aus der Talgdrüse vom Schaf", "4 "] ,  ["Lanolin Acid / Lanolinfettsäure", "4"] ,  ["Lanolic Alcohol / Lanolinalkohol", "2"] ,  ["Laureth-23 / PEG", "3 "] ,  ["Laureth-4 / PEG", "5"] ,  ["Lauric Acid / Laurinsäure", "4"] ,  ["Lauryl Alcohol / Fettalkohol", "2"] ,  ["Linseed Oil / Leinsamenöl", "5"] ,  ["Mink Oil / Nerzöl", "3 "] ,  ["Myreth-3 Myristate / PEG", "5"] ,  ["Myristic Acid / Perlglanzmittel", "3 "] ,  ["Myristyl Lactate / Milchsäuremyristylester", "4"] ,  ["Myristyl Myristate / Ester der Myristinsäure mit Myristylalkohol", "5 "] ,  ["Octanol / Alkohol", "? "] ,  ["Octyldodecanol / Fettalkohol", "3"] ,  ["Octyl Palmitate / Fettsäureester", "4 "] ,  ["Octyl Stearate / Lipid", "5 "] ,  ["Olea Europaea / Olivenöl", "4"] ,  ["Olive Oil / Olivenöl", "4"] ,  ["Oleic Acid / Ölsäure", "4"] ,  ["Oleth-3 / PEG", "5 "] ,  ["Oleyl Alcohol / Lösungsmittel", "4 "] ,  ["PEG-16 Lanolin / PEG ", "4 "] ,  ["PEG-200 Dilaurate / PEG ", "3 "] ,  ["PEG-300 / PEG ", "? "] ,  ["PEG-12 Polyethylenglycol / PEG ", "? "] ,  ["PEG-8 Stearate / PEG ", "3 "] ,  ["Petrolatum / Erdöl", "5 "] ,  ["Paraffinum liquidum / Erdöl", "5 "] ,  ["PEG Monostearate / PEG", "3 "] ,  ["Pinus / Holzteer", "3 "] ,  ["Pix Ex Carbone / Steinkohleteer", "5 "] ,  ["PPG-2-Myristyl Propionate / Glycole und Fettalkohole", "4 "] ,  ["Polyglyceryl-3-Diisostearate / Emulgator", "3 "] ,  ["Polyglyceryl-4 Isostearate / Emulgator", "4"] ,  ["Potassium Chloride / Verdinckungsmittel", "5 "] ,  ["Propylene Glycol Stearate / Lösungsmittel", "4 "] ,  ["Red Algae / Irish Moos / Rotalgen", "5 "] ,  ["Sesamum Indicum / Sesamöl", "3"] ,  ["Shark Liver Oil / Haifischleberöl", "3 "] ,  ["Sodium Chloride / Kochsalzlösung", "5 "] ,  ["Sodium Laureth Sulfate / Tensid", "3 "] ,  ["Sodium Lauryl Sulfate / Tensid", "5 "] ,  ["Sorbitan Oleate / Emulgator", "3 "] ,  ["Sorbitan Sesquioleate / Emulgator", "3 "] ,  ["Steareth-10 / PEG", "4 "] ,  ["Stearic Acid / Stearinsäure aus Schweinefett, Rindertalg, Kokosöl", "3"] ,  ["Stearyl Alcohol / Octadecanol", "2 "] ,  ["Sulfated Castor Oil / Rizinusölsulfonat", "3 "] ,  ["Sulfated Jojoba Oil / Jojobaölsulfonat", "3"] ,  ["Sulfur / Schwefel", "3 "] ,  ["Stearyl Heptanoate / Ester der Heptanoic Säure mit Stearylalkohol", "4 "] ,  ["Theobroma Cacao / Kakaobutter", "4 "] ,  ["Wheat Germ Glyceride / Weizenkeimölglyceride", "3 "] ,  ["Wheat Germ Oil / Weizenkeimöl", "5 "] ,  ["Xylene / Lösungsmittel", "4 "] ,  ["Zea Mays / Maisöl", "?"] ]; 
var data = [dataAcneOrg, dataBotanic, dataHautschutzengel];
var dataSourceUrl =  ["http://www.acne.org/messageboard/topic/319593-the-bad-list-comedogenic-ingredients-and-products/", "https://www.beneficialbotanicals.com/facts-figures/comedogenic-rating.html", "http://www.hautschutzengel.de/komedogene-inhaltsstoffe.html"];
var dataSourceSymbol =  ["AC", "BB", "HE"];


String.prototype.contains = function(searchFor) {
  return this.indexOf(searchFor) >= 0;
}
String.prototype.containsAny = function(searchFor) {
  for (var i=0;i<searchFor.length;i++) if (this.contains(searchFor[i])) return true;
  return false;
}
String.prototype.count = function(searchFor) {
  var res = 0;
  var i = this.indexOf(searchFor);
  while (i >= 0) {
    res++;
    i = this.indexOf(searchFor, i + searchFor.length);
  }
  return res;
}
Array.prototype.contains = function(searchFor) {
  return this.indexOf(searchFor) >= 0;
}

function normalizeName(name){
  return name.toLowerCase().replace(/[\s*]/g,"");
}
function splitParens(name)  {
  while (name.contains("(")) {
    var nobra = /(.*)\((.*)\)?(.*)/.exec(name);
    name = nobra[1]+"/"+nobra[2].split(",").join("/");
    if (nobra[3]) name += "/" + nobra[3];
  }
  return name;
}

for (var d=0;d<data.length;d++) {
  var subdata = data[d];
  for (var i=0;i<subdata.length;i++) {
    var name = splitParens(normalizeName(subdata[i][0]));    
    subdata[i] = [name.split("/")].concat( [subdata[i][0], normalizeName(subdata[i][1]), subdata[i][2] && subdata[i][2] != "?" ? normalizeName(subdata[i][2]) : ""] ); 
  }
}

//data is now [  /*data source 1:*/ [ /* ingred 1: */ [ [subname 1, subname 2, ..], name, comedogenic, irritating  ] , [ [ ingred 2 subname 1 ], name, co, irr ], ... ], [ /*data source 2*/], ...     ]


if (lang == "de") {
  txtTitle = "Komedogentester";
  txtList = "Liste der Inhaltsstoffe";
  txtCheck = "Stoffe überprüfen";
  txtResult = "Testergebnis";
  txtThreshold = "Minimale Namensähnlichkeit";
  txtLongDescription = '<h3>Fragen</h3>'+
    '<h4>Wie geht das?</h4><p>Kopiere eine Liste von Stoffen in das obere Eingabefeld und klicke "überprüfen". Stoffe mit einer niedrigen Einstufung (0) sind nicht komedogen, Stoffe mit einer hohen Einstufung (5) sind gefährlich.</p>' +
    '<h4>Warum findet es Stoffe, die nicht in meiner Liste stehen?</h4><p>Es sucht für jeden Stoff den Stoff mit dem ähnlichsten Namen in den Datenbanken. Wenn es in der Liste Stoffe gibt, die nicht in den Datenbanken vorkommen, wird ein anderer Stoff mit ähnlichem Namen im Ergebnis gelistet.  Mit einem höheren minimalen Ähnlichkeitsmaß, können diese Treffer ausgeschlossen werden, aber dann könnten auch richtig zugeordnete, falsch geschriebene Stoffe verschwinden.</p>' + 
    '<h4>Warum steht in einer Zeile, der Inhaltsstoff sei harmlos und in einer anderen Zeile, er sei gefährlich?</h4><p>Es werden unterschiedliche Datenbanken abgefragt, deren Einstufung nicht übereinstimmt.</p>';
  txtHeading = "<th>Inhaltsstoff</th><th>Ähnlichster bekannter Stoff</th><th>Komedogeneinstufung/th><th>Irritationseinstufung</th>";
  txtOkResult = "Keine komedogenen Inhaltsstoffe gefunden";
} else {
  txtTitle = "Comedogenic Ingredient Tester";
  txtList = "Ingredient list";
  txtCheck = "Check ingredients";
  txtResult = "Test result";
  txtThreshold = "Matching threshold";
  txtLongDescription = '<h3>Questions</h3>'+
    '<h4>How do I use this?</h4><p>Copy a list of ingredients in the top edit field and click the "check" button. Ingredients with low comedogenic rating (0) are safe, ingredients with high rating (5) are dangerous.</p>' +
    '<h4>Why does it output nonsensical matches?</h4><p>It uses a very simple text similarity score to find the match. If you have ingredients in the list that are not in the source database, it will find a random ingredient with similar name. Increase the threshold value to discard less similar matches.</p>' + 
    '<h4>Why is there one row saying the ingredient is safe and one row saying that it is unsafe?</h4><p>This tool only lists the ratings from the source databases. If those databases do not agree with each other, it reports it accordingly.</p>';
  txtHeading = "<th>Ingredient</th><th>Possible Match</th><th>Comedogenic rating</th><th>Irritation rating</th>";
  txtOkResult = "No comedogenic ingredients found";
}

function levenshtein(str1, str2) {
    var cost = new Array(),
        n = str1.length,
        m = str2.length,
        i, j;

    var minimum = function(a, b, c) {
        var min = a;
        if (b < min) {
            min = b;
        }
        if (c < min) {
            min = c;
        }
        return min;
    }

    if (n == 0) {
        return;
    }
    if (m == 0) {
        return;
    }

    for (var i = 0; i <= n; i++) {
        cost[i] = new Array();
    }

    for (i = 0; i <= n; i++) {
        cost[i][0] = i;
    }

    for (j = 0; j <= m; j++) {
        cost[0][j] = j;
    }

    for (i = 1; i <= n; i++) {
        var x = str1.charAt(i - 1);

        for (j = 1; j <= m; j++) {
            var y = str2.charAt(j - 1);

            if (x == y) {
                cost[i][j] = cost[i - 1][j - 1];
            } else {
                cost[i][j] = 1 + minimum(cost[i - 1][j - 1], cost[i][j - 1], cost[i - 1][j]);
            }

        } //endfor

    } //endfor

    return cost[n][m];
}


function strSim(s,t) {
  return 1 - levenshtein(s,t) / Math.max(s.length,t.length);
}

var STR_SIM_THRESHOLD = 0.75;

function element(id){ return document.getElementById("comedogenic-" + id);  }

function sourceLink(i) { return '<a href="'+dataSourceUrl[i]+'">'+dataSourceSymbol[i]+'</a>' }
function sourceLinks(sources) { return "(" + sources.map(sourceLink).join(", ") + ")"; }

function analyze(sraw) {
  STR_SIM_THRESHOLD = element("score").value * 1;
  var s = null;
  var splitChars = "|,:;";
  for (var i=0;i<splitChars.length;i++)
    if (sraw.contains(splitChars[i])) { 
      s = sraw.split(splitChars[i]); 
      break; 
    }
  if (!s) { alert("No ingredient separator found."); s = [sraw]; }
  var hasAnyBad = false;
  var badRows = ["","","","","",""];
  var enabledSources = [];
  for (var i=0;i<dataSourceSymbol.length;i++) enabledSources.push(element("source"+i).checked);
  for (var i=0;i<s.length;i++) {
    var names = splitParens(normalizeName(s[i]).replace(" ","","g")).split("/");
    var bad = {}; var isbad = false;
    for (var dseti=0;dseti<data.length;dseti++) { 
      if (!enabledSources[dseti]) continue;
      var bestMatchI = -1;
      var bestScore = 0;
      var dset = data[dseti];
      for (var j=0;j<dset.length;j++) {
        for (var k=0;k<dset[j][0].length;k++) {
          for (var l=0;l<names.length;l++) {
            var score = strSim(dset[j][0][k], names[l]);
            if (score > STR_SIM_THRESHOLD && score > bestScore) {
              bestScore = score;
              bestMatchI = j;
         //     alert(dset[j][0][k] + "|"+ names[l]);
            } 
          }
        }    
      }
    
      if (bestScore) {
        isbad = true;
        var matched = dset[bestMatchI];
        var code1 = normalizeName(matched[1] + ":" + matched[2]  );
        var code2 = normalizeName(matched[0][0] + ":" + matched[2] );
        var code = code1;
        if (!bad[code1] && bad[code2]) code = code2;
        if (!bad[code]) bad[code] = [];
        bad[code].push([dseti, matched]);
      }
    }
    if (isbad) {
      hasAnyBad = true;
      var ratingScore = {};
      var maxRatingScore = 0;
      for (prop in bad) {
        var matched = bad[prop][0][1];
        var maxed = matched[2];
        if (maxed.contains("-")) maxed = maxed.split("-")[maxed.split("-").length-1];
        maxed = maxed * 1;
        if (!(maxed  >= 0 && maxed < badRows.length)) maxed = badRows.length-1;
        ratingScore[prop] = maxed; 
        if (maxed > maxRatingScore) maxRatingScore = maxed;
      }
 
      function foldWithSourcesOnColumn(list,column) {
        var sources = {}; var names = {};
        for (var i=0;i<list.length;i++) { 
          var v = list[i][1][column];
          if (typeof v == "undefined") continue;
          var w = v.toString().toLowerCase();
          if (!sources[w]) sources[w] = [];
          sources[w].push(list[i][0]);
          names[w] = v;
        }
        var result = [];
        for (var prop in sources) if (names[prop]) result.push(names[prop] + " " + sourceLinks(sources[prop]));
        return result.join(", ");
      }
      var first = true;
      for (prop in bad) { 
        var matched = bad[prop][0][1];
        badRows[maxRatingScore] += '<tr class="comedogenic-rating'+ratingScore[prop]+'"><td class="comedogenic-rating'+maxRatingScore+'">' + (first ? s[i] : "") + " </td> <td> => " + foldWithSourcesOnColumn(bad[prop],1)+'</td><td style="text-align:center">'+matched[2]+'</td><td style="text-align:center">'+foldWithSourcesOnColumn(bad[prop],3)+"</td>" ;
        first = false;
      }
      
    }
  }
  var badTable;
  if (hasAnyBad) {
    badTable = "<thead><tr>"+txtHeading+"</tr></thead>";
    for (var i=badRows.length-1;i>=0;i--) badTable += badRows[i];
  } else {
    badTable = '<tr class="comedogenic-rating0"><td> => '+txtOkResult+'</td></tr>';
  }
  element("out").innerHTML = badTable;
}

/*while (true) {
  var s = prompt();
  if (!s) break;
  analyze(s);
}*/

var style=document.createElement("style");
style.textContent = ".comedogenic-rating0 { background-color: #99FF99 }" + 
  ".comedogenic-rating1 { background-color: #BBFF33 }" +
  ".comedogenic-rating2 { background-color: #FFFF33 }" +
  ".comedogenic-rating3 { background-color: #FFCC22 }" +
  ".comedogenic-rating4 { background-color: #FF8822 }" +
  ".comedogenic-rating5 { background-color: #FF4444 }" +
  "#comedogenic-out td {padding: 4px}" 
  ;
document.getElementsByTagName("head")[0].appendChild(style);

var sourceshtml="";
for (var i=0;i<dataSourceSymbol.length;i++)
  sourceshtml += '<input id="comedogenic-source'+i+'" type="checkbox" checked> '+sourceLink(i);


element("placeholder").innerHTML = '<h3>'+txtTitle+'</h3>' +
  txtList+': <textarea class="form-control" rows="3" id="comedogenic-in"></textarea><br>' + 
  '<button class="btn btn-primary" onclick="javascript:analyze(element(\'in\').value)">'+txtCheck+'</button> <span style="padding-left:2em">'+txtThreshold+':</span> <input type="edit" id="comedogenic-score" value="'+STR_SIM_THRESHOLD+'" size="5" style="text-align: right"/> % <span style="padding-left:2em">Databases:</span>'+sourceshtml+ 
  '<h4>'+txtResult+'</h4>' +
  '<table id="comedogenic-out" style="display:block; width: 100%"></table>' + "<br><br><br>" +
  txtLongDescription 
  ;

var args = /[?&]comedogenic-check=([^&]+)/.exec(location.toString());
if (args) { element("in").value = unescape(args[1]);  analyze(unescape(args[1])); }

/*

True ingredient => Matched 0-5 3 (HE,AC)
True ingredient 2 => Matched 3 ? (BB)
                  => Matched 0 0 (AC)*/
